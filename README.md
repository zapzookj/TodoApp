
# 🏁 **회원가입, 로그인 기능(+JWT 필터 인증 및 인가 처리)이 있는 투두앱 백엔드 서버 API"**
  
- [X]  **회원 가입 API**
    - username, password를 Client에서 전달받기
    - username은  `최소 4자 이상, 10자 이하이며 알파벳 소문자(a~z), 숫자(0~9)`로 구성되어야 한다.
    - password는  `최소 8자 이상, 15자 이하이며 알파벳 대소문자(a~z, A~Z), 숫자(0~9)`로 구성되어야 한다.
    - DB에 중복된 username이 없다면 회원을 저장하고 Client 로 성공했다는 메시지, 상태코드 반환하기
- [X]  **로그인 API**
    - username, password를 Client에서 전달받기
    - DB에서 username을 사용하여 저장된 회원의 유무를 확인하고 있다면 password 비교하기
    - 로그인 성공 시, 로그인에 성공한 유저의 정보와 JWT를 활용하여 토큰을 발급하고, 
    발급한 토큰을 Header에 추가하고 성공했다는 메시지, 상태코드 와 함께 Client에 반환하기
- [X]  **할일카드 작성 기능 API**
    - 토큰을 검사하여, 유효한 토큰일 경우에만 할일 작성 가능
    - `할일 제목`,`할일 내용`, `작성일`을 저장할 수 있습니다. (~~작성자명, 비밀번호)~~
    - 할일 제목, 할일 내용을 저장하고
    - 저장된 할일을 Client 로 반환하기(username은 로그인 된 사용자)
- [X]  **선택한 할일카드  조회 기능 API**
    - 선택한 할일 의 정보를 조회할 수 있습니다.
        - 반환 받은 할일 정보에는 `할일 제목`,`할일 내용`, `작성자` , `작성일`정보가 들어있습니다.
- [X]  **할일카드 목록 조회 기능 API**
    - 등록된 할일 전체를 조회할 수 있습니다.
        - 회원별로 각각 나누어서 할일 목록이 조회됩니다.
        - 반환 받은 할일 정보에는 `할일 제목`, `작성자` , `작성일`, `완료 여부`정보가 들어있습니다.
    - 조회된 할일 목록은 `작성일` 기준 내림차순으로 정렬 되어있습니다.
- [X]  **선택한 할일카드 수정 기능 API**
    - 선택한 할일카드의 `제목`, `작성 내용`을 수정할 수 있습니다. (~~작성자명~~)
        - 토큰을 검사한 후, 유효한 토큰이면서 해당 사용자가 작성한 게시글만 수정 가능
        - 할일 제목, 할일 내용을 수정하고 수정된 할일 정보는 Client 로 반환됩니다.
    - 수정된 할일의 정보를 반환 받아 확인할 수 있습니다.
        - 반환 받은 할일 정보에는 `할일 제목`,`할일 내용`, `작성자` , `작성일`정보가 들어있습니다.
- [X]  **할일카드 완료 기능 API**
    - 토큰을 검사한 후, 유효한 토큰이면서 해당 사용자가 작성한 할일카드 만 완료 가능
    - 완료처리 한 할일카드는 목록조회시 `완료 여부`필드가 TRUE 로 내려갑니다.
    - `완료 여부` 기본값은 FALSE
- [X]  **댓글 작성 API**
    - 토큰을 검사하여, 유효한 토큰일 경우에만 댓글 작성 가능
    - 선택한 할일의 DB 저장 유무를 확인하기
    - 선택한 할일이 있다면 댓글을 등록하고 등록된 댓글 반환하기
- [X]  **댓글 수정 API**
    - 토큰을 검사한 후, 유효한 토큰이면서 해당 사용자가 작성한 댓글만 수정 가능
    - 선택한 댓글의 DB 저장 유무를 확인하기
    - 선택한 댓글이 있다면 댓글 수정하고 수정된 댓글 반환하기
- [X]  **댓글 삭제 API**
    - 토큰을 검사한 후, 유효한 토큰이면서 해당 사용자가 작성한 댓글만 삭제 가능
    - 선택한 댓글의 DB 저장 유무를 확인하기
    - 선택한 댓글이 있다면 댓글 삭제하고 Client 로 성공했다는 메시지, 상태코드 반환하기
     
- [X]  **예외 처리 (ResponseEntity 사용)**
    - 토큰이 필요한 API 요청에서 토큰을 전달하지 않았거나 정상 토큰이 아닐 때는 "토큰이 유효하지 않습니다." 라는 에러메시지와 statusCode: 400을 Client에 반환하기
    - 토큰이 있고, 유효한 토큰이지만 해당 사용자가 작성한 게시글/댓글이 아닌 경우에는 “작성자만 삭제/수정할 수 있습니다.”라는 에러메시지와 statusCode: 400을 Client에 반환하기
    - DB에 이미 존재하는 username으로 회원가입을 요청한 경우 "중복된 username 입니다." 라는 에러메시지와 statusCode: 400을 Client에 반환하기
    - 로그인 시, 전달된 username과 password 중 맞지 않는 정보가 있다면 "회원을 찾을 수 없습니다."라는 에러메시지와 statusCode: 400을 Client에 반환하기
     

💡 **추가 기능 구현 사항**

- [X] 전체 할일카드 목록에서 완료된 카드들은 숨김처리 하는 기능
- [X] 할일카드를 작성자만 볼 수 있도록 비공개 하는 기능
- [X] 할일카드 제목으로 검색하여 목록을 출력하는 기능
- [X] 프로젝트에 swagger 적용
- [X] AccessToken, RefreshToken 구현 (DB에서 구현)

# **레거시 코드 리팩토링**

## **코드 개선 및 추가적인 기능 구현**
- [X]  **Controller 기능 개선**
  - UserController 기능 개선 : 예외 처리 핸들러를 활용
  - TodoController 기능 개선 : API URL 개선, ResponseEntity를 이용한 반환값 통일
  - CommentController 기능 개선 : ResponseEntity를 이용한 반환값 통일
- [X]  **Service 기능 개선**
  - TodoService 기능 개선 : 쿼리 메서드를 활용한 성능 최적화, Comment 도메인과 관심사 분리
  - CommentService 기능 개선 : 댓글 조회 API 추가
- [X]  **CustomException 추가**
  - NotFoundException 추가
- [X]  **AOP 기능 추가**
  - ApiUseTime AOP 기능 추가 : 유저별 API 사용 시간 기록
- [X]  **JWT 인가 로직 개선**
  - JWT 토큰이 무상태성을 유지할 수 있도록 로직 수정
  - JWT 토큰을 통한 유저 인증 시, DB를 조회하지 않고 JWT 토큰에 담긴 정보만으로 유저 인증 및 인증 객체 생성
  - 사용자 인가가 필요한 API에 접근 시, 불필요한 유저 조회 쿼리 생성 제거
- [X]  **QueryDSL 적용**
  - 각 도메인별로 QueryDSL을 적용하여 RepositoryQueryImpl 생성
  - N+1 문제 해결
- [X]  **페이징 및 정렬 기능 적용**
  - Pageable을 사용하여 원하는 페이지 사이즈만큼 조회할 수 있도록 개선
- [X]  **Redis 적용 및 Refresh Token 기능 추가**
  - Docker를 활용하여 프로젝트에 Redis 적용
  - 인증 및 인가 로직에 Refresh Token 기능 추가
- [X]  **AWS S3 적용**
  - User 프로필 등록 API 추가
  - AWS S3를 활용하여 유저의 프로필 이미지를 저장 및 조회할 수 있는 기능 추가
- [X]  **테스트 코드 개선**
  - Entity 테스트 코드 추가
  - 추가된 기능들을 포함하여 Controller, Service, Repository 테스트 코드 개선

## **추가적으로 개선해야 할 사항**
- []  **JWT 토큰 검증 중복 문제 개선**
  - JwtAuthorizationFilter > doFilterInternal() 메서드 개선 필요
- []  **불필요한 쿼리 생성 최적화**
  - 불필요한 find 쿼리 메서드 대신 exist로 대체
- []  **테스트 코드 추가**
  - Redis, AWS S3 관련 테스트 코드
  - Aop 테스트 코드
  - util 테스트 코드
  - 통합 테스트 코드

## **프로젝트 진행 중 생긴 궁금한 점**
### **createToken VS Select Query**
이번 레거시 코드 개선 프로젝트에서 저는 JWT가 무상태성을 유지할 수 있도록 JWT 관련 코드를 개선하였습니다.
코드가 개선된 이후에는 유저 인가가 필요한 API에 접근할 때 DB에 유저 조회를 해서 User 객체를 생성하는 방식이 아닌,
JWT에 담긴 유저 정보로 UserDetails와 User 객체를 생성하도록 로직이 변경되었습니다.

이후 User 프로필 등록 API를 구현하였는데, 여기서 두 가지 문제점이 발생했습니다.

1.JWT 토큰에는 유저 패스워드가 포함되어 있지 않은데, JWT 토큰을 통해 생성한 User 객체를 새로 등록된 프로필 정보와 함께 DB에 업데이트하니 DB에 있던 User 패스워드가 날아가버림
2.JWT 토큰을 통해 로그인한 유저가 프로필 등록 API를 통해 DB에 유저 정보를 갱신해도, 해당 갱신된 정보가 JWT 토큰에는 갱신되지 않음.
즉, JWT 토큰을 새로 발급받기 전까진 수정된 프로필 정보를 조회할 수 없음.

일단, 1번 문제는 수정된 정보만을 업데이트하는 JPQL을 새로 만들어서 해결하였습니다.
2번 문제는 로그인을 다시 해서 JWT 토큰을 새로 발급받으면 해결될 문제지만, 그건 클라이언트 입장에서 너무 번거로울 것 같다는 생각이 들었습니다.
따라서 제가 떠올린 해결 방법은 두 가지였습니다.

1.프로필 관련 API에서 DB User 조회 쿼리를 발생시킨다.
2.프로필 수정을 할 때마다, 새로운 Access Token을 생성해 클라이언트에게 반환한다.

두 방식 모두 서버 입장에서 추가적인 비용이 발생하기는 하지만, 저는 일단 2번 방식을 통해서 문제를 해결했습니다.
두 방식중 어떤 방식이 서버 입장에서 부담이 적은 방식일지 궁금합니다.
또 이 외에 다른 해결 방법이 있는지 궁금합니다.

# API 명세서
![스크린샷 2024-02-02 163917](https://github.com/zapzookj/TodoApp/assets/154570825/66576163-9f2d-484c-914b-8e1714d6eac3)
![4321](https://github.com/zapzookj/TodoApp/assets/154570825/5a491228-7e40-45b7-8c3d-8a60cb76f818)
![스크린샷 2024-02-02 164047](https://github.com/zapzookj/TodoApp/assets/154570825/1acd2632-101b-4534-8fca-914cdaa4223c)

# ERD
![555](https://github.com/zapzookj/TodoApp/assets/154570825/6e6eae32-5ad7-4f5a-a99f-b93299594e0b)
